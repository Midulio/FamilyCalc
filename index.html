<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400..800&family=Fredoka:wght@300..700&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100..900;1,100..900&family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100..900;1,100..900&family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link href="style.css" rel="stylesheet"/>
    <link rel="icon" type="image/png" href="src/logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilyCalc</title>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>

    <nav class="navbar">
        <div class="container-fluid d-flex align-items-center justify-content-between">
            <button class="btn btn-primary menu" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasWithBothOptions" aria-controls="offcanvasWithBothOptions"><img src="src/list.svg"></button>
            <div class="offcanvas offcanvas-start interiorMenu" data-bs-scroll="true" tabindex="-1" id="offcanvasWithBothOptions" aria-labelledby="offcanvasWithBothOptionsLabel">
            <div class="offcanvas-header">
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body interiorMenu">
                <div class="explorar"> <h4>EXPLORAR</h4>
                    <a href="views/casas/index_casa.php"><img src="src/users.svg">Personas</a>
                    <a href="views/Impuestos_valores/imp_val.html"><img src="src/percent.svg">Valores</a>
                    <a href="views/movimientos/index_movimientos.php"><img src="src/receipt.svg">Resumen de gastos</a>
                    <a href="#"><img src="src/chart-line.svg">Estad√≠sticas de gastos</a>
                </div>
                <div class="container-fluid d-flex justify-content-between contactos-box position-absolute bottom-0 start-50 translate-middle-x">
                    <a class="contactos" href="#"><img class="position-absolute top-50 start-50 translate-middle" src="src/facebook-logo.svg"></a>
                    <a class="contactos" href="#"><img class="position-absolute top-50 start-50 translate-middle" src="src/instagram-logo.svg"></a>
                    <a class="contactos" href="#"><img class="position-absolute top-50 start-50 translate-middle" src="src/envelope.svg"></a>
                    <a class="contactos" href="#"><img class="position-absolute top-50 start-50 translate-middle" src="src/phone.svg"></a>
                </div>
            </div>
            </div>
            <a href="index.html" class="logo"><h1 class="mb-1 fs-2"><span class="family">Family</span><span class="calc">Calc</span></h1></a>
            <div>
                <a href="views/chatbot/chatbot.html" class="btn menu" type="button"><img src="src/robot.svg"></a>
                <div id="bot-tooltip">
                    üëã Haz clic AQU√ç para ABRIR el CHAT con el BOT ü§ñ
                </div>
                <div class="btn menu" id="userMenu"></div>
            </div>
        </div>
    </nav>
    <section class="container-sm">
        <a href="views/movimientos/index_movimientos.php" class="animacionHover" id="movimientos">
            <div class="gastos position-relative">
                <div class="gastosTitulo position-relative">
                    <h2> Gasto Total </h2>
                    <h3 class="position-absolute top-50 end-0 translate-middle-y">Resumen de gastos</h3>
                </div>
                <div class="numeroGastos sco mx-auto">
                    <p id="totalImporte"><span>ARS</span></p>
                </div>
                <div class="position-absolute resumenGastos scrollcontainer text-center">

                </div>
            </div>
        </a>
            <div class="row text-center justify-content-center mb-4">
            <div class="btnChicos col-6 col-sm-4 mb-3">
                <a href="views/casas/index_casa.php" class="btnChicos animacionHover" id="casas"><img src="src/housewhite.svg"></a>
                <p>Casa/s</p>
            </div>

            <div class="btnChicos col-6 col-sm-4 mb-3">
                <a href="#" class="btnChicos animacionHover" id="estadisticas"><img src="src/chart-barwhite.svg"></a>
                <p>Estad√≠sticas de gastos</p>
            </div>

            <div class="btnChicos col-6 col-sm-4 mb-3">
                <a href="views/Impuestos_valores/imp_val.html" class="btnChicos animacionHover" id="impuestos"><img src="src/currency-dollar-simplewhite.svg"></a>
                <p>Valores</p>
            </div>
        </div>
    </div>
    </section>




<script src="api/sessionMenu.js"></script>
<!-- JS -->
<script>
window.addEventListener("DOMContentLoaded", async () => {
  // --- TOOLTIP (sin cambios) ---
  const tooltip = document.getElementById("bot-tooltip");
  const maxShows = 3;
  let shows = localStorage.getItem("botTooltipShows") || 0;
  let lastShown = localStorage.getItem("botTooltipLastShown");
  const today = new Date().toDateString();

  if (shows < maxShows && lastShown !== today) {
    tooltip.style.display = "block";
    localStorage.setItem("botTooltipShows", ++shows);
    localStorage.setItem("botTooltipLastShown", today);
    setTimeout(() => tooltip.style.display = "none", 5000);
  }

  // --- DETECCI√ìN DE RUTA BASE AUTOM√ÅTICA ---
  const origin = window.location.origin;
  const pathParts = window.location.pathname.split("/").filter(Boolean);
  const projectFolder = pathParts[0] || "FamilyCalc"; // si cambia el nombre, se adapta solo
  const baseUrl = `${origin}/${projectFolder}`;
  const loginUrl = `${baseUrl}/views/usuarios/iniciarSesion.html`;

  // --- BOTONES ---
  const btnResumen = document.querySelector("a#movimientos");
  const btnCasas = document.querySelector("a#casas");
  const btnEstadisticas = document.querySelector("a#estadisticas");

  // --- CHEQUEO DE SESI√ìN ---
  try {
    const response = await fetch(`${baseUrl}/api/checkSession.php`);
    const data = await response.json();

    const totalImporte = document.getElementById("totalImporte");
    const resumenContainer = document.querySelector(".resumenGastos");

    // Si el usuario NO est√° logueado
    if (!data.logged) {
      totalImporte.innerHTML = `<span class="fw-bold deslogueado">Debe iniciar sesi√≥n para ver los gastos</span>`;
      resumenContainer.innerHTML = "";

      const botones = [btnResumen, btnCasas, btnEstadisticas];

      // ‚ö° Fuerza el comportamiento correcto de redirecci√≥n
      botones.forEach(boton => {
        if (!boton) return;
        boton.setAttribute("href", "#");
        boton.addEventListener("click", e => {
          e.preventDefault();
          window.location.href = loginUrl;
        });
      });

      return; // Detiene el resto del script
    }

    // --- SI HAY SESI√ìN ACTIVA ---

    // FETCH total_importe.php
    fetch(`${baseUrl}/views/movimientos/total_importe.php`)
      .then(response => response.text())
      .then(data => {
        totalImporte.innerHTML = `$${data}<span>ARS</span>`;
      });

    // FETCH resumen_gastos.php
    fetch(`${baseUrl}/views/movimientos/resumen_gastos.php`)
      .then(response => response.json())
      .then(data => {
        resumenContainer.innerHTML = "";

        const iconos = {
          "Entretenimiento": "src/popcorn.svg",
          "Indumentaria": "src/bag.svg",
          "Salud": "src/first-aid.svg",
          "Videojuegos o Suscripciones": "src/game-controller.svg",
          "Viajes": "src/airplane.svg",
          "Cuentas Bancarias": "src/bank2.svg",
          "Regalos": "src/gift.svg"
        };

        if (data.length > 0) {
          const totalGeneral = data.reduce((acc, item) =>
            acc + parseFloat(item.total.replace('.', '').replace(',', '.')), 0);

          data.forEach(item => {
            const div = document.createElement('div');
            div.classList.add('resumen-item');
            div.style.display = 'flex';
            div.style.gap = '10px';
            div.style.marginBottom = '20px';

            const img = document.createElement('img');
            img.src = iconos[item.servicio] || "src/other.svg";
            img.alt = item.servicio;
            img.style.width = '60px';
            img.style.height = '60px';
            img.style.marginLeft = '.1rem';
            img.style.marginTop = '.2rem';

            const texto = document.createElement('span');
            texto.innerHTML = `<span class="pos-img mx-auto mx-md-2 mt-md-2">$${item.total}</span>`;

            div.appendChild(img);
            div.appendChild(texto);
            resumenContainer.appendChild(div);
          });
        } else {
          resumenContainer.innerHTML = '<p class="text-muted mx-auto my-3">No hay movimientos registrados.</p>';
        }
      })
      .catch(error => console.error('Error al cargar el resumen de gastos:', error));

  } catch (error) {
    console.error("Error verificando sesi√≥n:", error);
  }
});
</script>

</body>
</html>